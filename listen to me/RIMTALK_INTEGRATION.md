# ?? RimTalk 集成完成

## ? 已实现的功能

### 核心功能
1. **文本指令窗口** - 可以通过UI输入指令
2. **Enter 键执行** - 输入后按回车即可执行
3. **右键菜单** - 右键点击小人可选择"文本指令..."
4. **RimTalk 对话监听** - 使用 RimTalk 对话时自动识别指令

---

## ?? 完整的指令执行方式

### 方式 1: 文本指令按钮
```
选中小人 → 点击底部"文本指令"按钮 → 输入指令 → Enter键
```

### 方式 2: 右键菜单
```
右键点击小人 → 选择"文本指令..." → 输入指令 → Enter键
```

### 方式 3: 快捷键
```
选中小人 → 按 L 键 → 输入指令 → Enter键
```

### 方式 4: RimTalk 对话（新！）?
```
右键点击小人 → RimTalk 对话 → 输入: [玩家]: 去厨房 → 小人自动执行
```

---

## ?? RimTalk 集成工作原理

### 对话格式
RimTalk 使用以下格式：
```
[玩家]: 去厨房做饭
[小人名字]: 好的，我这就去
```

### 自动识别流程
1. **玩家通过 RimTalk 对话说出指令**
   - 例如：`[玩家]: 去厨房`

2. **ListenToMe 监听对话**
   - 拦截 RimTalk 的对话记录
   - 提取玩家说的话

3. **解析指令**
   - 使用 CommandParser 解析
   - 识别指令类型（Move/Work/Fight等）

4. **执行指令**
   - 如果是有效指令 → 自动执行
   - 如果不是指令 → 跳过，正常对话

### 示例对话

**指令对话**：
```
[玩家]: 等待
→ ListenToMe 识别为 Wait 指令
→ 小人停止工作并等待
→ 显示消息：? [小人名字] 理解了你的指令: 等待
```

**普通对话**：
```
[玩家]: 你好吗？
→ ListenToMe 识别为非指令
→ RimTalk AI 正常生成回应
→ 不执行任何指令
```

---

## ?? 技术实现

### Harmony Patch 目标

#### 1. TalkHistory.Add
```csharp
// 监听对话记录添加
RimTalk.Data.TalkHistory.Add()
→ OnRimTalkDialogueAdded()
→ 提取玩家对话内容
→ 解析并执行指令
```

#### 2. Dialog_Talk.SendMessage
```csharp
// 监听对话发送
RimTalk.UI.Dialog_Talk.SendMessage()
→ OnDialogSendMessage()
→ 实时拦截输入
→ 执行指令
```

### 容错机制
- ? RimTalk 未安装 → 正常工作，跳过对话监听
- ? Patch 失败 → 记录警告，不影响其他功能
- ? 解析失败 → 跳过，正常对话
- ? 执行失败 → 显示错误消息

---

## ?? 使用指南

### 测试 RimTalk 集成

1. **确保 RimTalk Mod 已启用**
2. **进入游戏**
3. **右键点击小人**
4. **选择 RimTalk 对话选项**（不是"文本指令..."）
5. **输入**：`[玩家]: 等待`
6. **发送**
7. **观察**：
   - 小人应该理解并执行等待指令
   - 屏幕显示：`? [小人名字] 理解了你的指令: 等待`
   - 小人停止工作

### 支持的指令

所有标准指令都支持：

```
移动类: 去厨房 / 到仓库 / 前往医疗室
工作类: 做饭 / 在裁缝台工作 / 清洁
战斗类: 攻击敌人 / 消灭入侵者
制作类: 制作防尘大衣 / 做3个木墙
其他类: 等待 / 狩猎 / 采集 / 挖矿 / 治疗
```

### 对话模式选择

#### 不勾选"使用对话模式"
```
[玩家]: 去厨房
→ 立即执行
→ 无对话气泡
```

#### 勾选"使用对话模式"
```
[玩家]: 去厨房
→ 小人回应："好的"
→ 显示对话气泡
→ 1-2秒后执行
```

---

## ?? 故障排除

### 问题: RimTalk 对话不执行指令

**检查**：
1. 查看日志是否有 `[ListenToMe] 检测到玩家对话` 消息
2. 确认指令格式：必须以 `[玩家]:` 开头
3. 确认 RimTalk 版本兼容性

**解决**：
- 如果没有检测到 → Patch 可能失败
- 查看日志中的 Patch 消息
- 尝试重启游戏

### 问题: 对话被识别但不执行

**原因**：指令解析失败

**解决**：
1. 使用简单指令测试：`[玩家]: 等待`
2. 检查日志：`[ListenToMe] 识别为指令: Wait`
3. 如果显示 `不是指令，跳过` → 换个说法

### 问题: 所有对话都被当作指令

**不会发生**：只有能解析为指令的才执行
- `[玩家]: 你好` → 正常对话
- `[玩家]: 天气真好` → 正常对话
- `[玩家]: 去厨房` → 执行指令 ?

---

## ?? 日志示例

### 成功集成 RimTalk
```
[ListenToMe] 尝试集成 RimTalk 对话监听...
[ListenToMe] ? 成功 Patch RimTalk 对话监听
[ListenToMe] ? 成功 Patch RimTalk 对话输入
```

### RimTalk 未安装
```
[ListenToMe] RimTalk 未安装，跳过对话监听
```

### 执行指令
```
[ListenToMe] 检测到玩家对话: '[玩家]: 去厨房' (对象: [小人名字])
[ListenToMe] ? 识别为指令: Move
[ListenToMe] 开始执行指令: 去厨房 | 类型: Move
[ListenToMe] ? 指令执行成功
```

---

## ?? 现在完整支持四种方式！

1. ? 文本指令按钮
2. ? 右键菜单
3. ? 快捷键 (L)
4. ? RimTalk 对话 ?

**无论用哪种方式，小人都能理解并执行你的指令！**

---

*最后更新: v1.2.0*  
*新功能: RimTalk 对话集成*
