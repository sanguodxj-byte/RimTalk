<?xml version="1.0" encoding="utf-8"?>
<Patch>
	<!-- ========================================
		 Facial Animation 兼容补丁
		 为血龙种添加完整面部动画支持
		 
		 需要玩家安装: [NL] Facial Animation - WIP
		 Workshop: https://steamcommunity.com/sharedfiles/filedetails/?id=1635901197
	========================================= -->
	
	<Operation Class="PatchOperationSequence">
		<success>Always</success>
		<operations>
			<!-- 检测 Facial Animation 是否存在 -->
			<li Class="PatchOperationFindMod">
				<mods>
					<li>[NL] Facial Animation - WIP</li>
					<li>Facial Animation WIP</li>
					<li>Facial Animation</li>
				</mods>
				
				<match Class="PatchOperationSequence">
					<success>Always</success>
					<operations>
						<!-- 步骤1：确保血龙种启用面部动画 -->
						<li Class="PatchOperationAdd">
							<xpath>/Defs/AlienRace.ThingDef_AlienRace[defName="Sideria_Dracovampir"]/alienRace[not(compatibility)]</xpath>
							<value>
								<compatibility>
									<isFacialAnimationDisabled>false</isFacialAnimationDisabled>
								</compatibility>
							</value>
						</li>
						
						<!-- 步骤2：如果compatibility节点已存在，确保FA未被禁用 -->
						<li Class="PatchOperationReplace">
							<xpath>/Defs/AlienRace.ThingDef_AlienRace[defName="Sideria_Dracovampir"]/alienRace/compatibility/isFacialAnimationDisabled</xpath>
							<value>
								<isFacialAnimationDisabled>false</isFacialAnimationDisabled>
							</value>
						</li>
						
						<!-- 步骤3：配置血龙种的表情贴图路径 -->
						<li Class="PatchOperationAdd">
							<xpath>/Defs/AlienRace.ThingDef_AlienRace[defName="Sideria_Dracovampir"]/alienRace/generalSettings/alienPartGenerator</xpath>
							<value>
								<!-- FA表情配置 -->
								<facialAnimationSettings>
									<!-- 启用FA -->
									<enabled>true</enabled>
									
									<!-- 眼睛贴图路径 -->
									<eyeTexturePath>Things/Pawn/Humanlike/Heads/Dracovampir/Eyes</eyeTexturePath>
									
									<!-- 嘴巴贴图路径 -->
									<mouthTexturePath>Things/Pawn/Humanlike/Heads/Dracovampir/Mouth</mouthTexturePath>
									
									<!-- 基础头部贴图路径 -->
									<baseTexturePath>Things/Pawn/Humanlike/Heads/Dracovampir/Base</baseTexturePath>
									
									<!-- 眼睛位置偏移（根据实际贴图调整） -->
									<eyeOffsetSouth>(0.0, 0.15)</eyeOffsetSouth>
									<eyeOffsetNorth>(0.0, 0.12)</eyeOffsetNorth>
									<eyeOffsetEast>(0.05, 0.13)</eyeOffsetEast>
									
									<!-- 嘴巴位置偏移（根据实际贴图调整） -->
									<mouthOffsetSouth>(0.0, 0.05)</mouthOffsetSouth>
									<mouthOffsetNorth>(0.0, 0.03)</mouthOffsetNorth>
									<mouthOffsetEast>(0.05, 0.04)</mouthOffsetEast>
									
									<!-- 眨眼频率（秒） -->
									<blinkInterval>3.5</blinkInterval>
									
									<!-- 表情切换延迟 -->
									<expressionTransitionTime>0.5</expressionTransitionTime>
								</facialAnimationSettings>
							</value>
						</li>
						
						<!-- 步骤4：日志通知 - FA兼容性已启用 -->
						<li Class="PatchOperationAdd">
							<xpath>/Defs</xpath>
							<value>
								<!-- 占位符ThingDef，用于确认补丁加载 -->
								<ThingDef Name="Sideria_FA_Loaded" Abstract="True">
									<label>Sideria FA Compatibility Loaded</label>
									<description>This confirms Facial Animation compatibility for Dracovampir race is active.</description>
								</ThingDef>
							</value>
						</li>
					</operations>
				</match>
			</li>
		</operations>
	</Operation>
	
	<!-- 
		表情贴图文件路径说明：
		
		Textures/Things/Pawn/Humanlike/Heads/Dracovampir/
		├── Base_south.png, Base_north.png, Base_east.png
		├── Eyes_Open_south.png, Eyes_Open_north.png, Eyes_Open_east.png
		├── Eyes_Half_south.png, Eyes_Half_north.png, Eyes_Half_east.png
		├── Eyes_Closed_south.png, Eyes_Closed_north.png, Eyes_Closed_east.png
		├── Eyes_Happy_south.png, Eyes_Happy_north.png, Eyes_Happy_east.png
		├── Eyes_Angry_south.png, Eyes_Angry_north.png, Eyes_Angry_east.png
		├── Eyes_Sad_south.png, Eyes_Sad_north.png, Eyes_Sad_east.png
		├── Eyes_Pain_south.png, Eyes_Pain_north.png, Eyes_Pain_east.png
		├── Mouth_Neutral_south.png, Mouth_Neutral_north.png, Mouth_Neutral_east.png
		├── Mouth_Smile_south.png, Mouth_Smile_north.png, Mouth_Smile_east.png
		├── Mouth_Frown_south.png, Mouth_Frown_north.png, Mouth_Frown_east.png
		├── Mouth_Talk1_south.png, Mouth_Talk1_north.png, Mouth_Talk1_east.png
		├── Mouth_Talk2_south.png, Mouth_Talk2_north.png, Mouth_Talk2_east.png
		├── Mouth_Talk3_south.png, Mouth_Talk3_north.png, Mouth_Talk3_east.png
		└── Mouth_Open_south.png, Mouth_Open_north.png, Mouth_Open_east.png
		
		详细实施指南见：FACIAL_ANIMATION_IMPLEMENTATION.md
	-->
	
</Patch>
